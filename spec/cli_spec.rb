require "spec_helper"
require_relative "../lib/govuk_docker/cli"

describe GovukDocker::CLI do
  let(:command) { nil }
  let(:args) { [] }
  subject { described_class.start([command] + args) }
  let(:command_double) { double }
  before { allow(command_double).to receive(:call) }

  describe "run" do
    let(:command) { "run" }

    context "without stack and service arguments" do
      it "runs in the lite stack" do
        expect(GovukDocker::Commands::Run)
          .to receive(:new).with(stack: "lite", verbose: false)
          .and_return(command_double)
        expect(command_double).to receive(:call).with([])
        subject
      end
    end

    context "with stack and service arguments" do
      let(:args) { ["--service", "static", "--stack", "app"] }

      it "runs in the specified stack" do
        expect(GovukDocker::Commands::Run)
          .to receive(:new).with(service: "static", stack: "app", verbose: false)
          .and_return(command_double)
        expect(command_double).to receive(:call).with([])
        subject
      end
    end

    context "with stack argument and no service argument" do
      let(:args) { ["--stack", "app"] }

      it "runs in the specified stack" do
        expect(GovukDocker::Commands::Run)
          .to receive(:new).with(stack: "app", verbose: false)
          .and_return(command_double)
        expect(command_double).to receive(:call).with([])
        subject
      end
    end

    context "with service argument and no stack argument" do
      let(:args) { ["--service", "static"] }

      it "runs in the specified stack" do
        expect(GovukDocker::Commands::Run)
          .to receive(:new).with(service: "static", stack: "lite", verbose: false)
          .and_return(command_double)
        expect(command_double).to receive(:call).with([])
        subject
      end
    end

    context "with additional arguments" do
      let(:args) { %w[bundle exec rspec] }

      it "runs the command with additional arguments" do
        expect(GovukDocker::Commands::Run)
          .to receive(:new).with(stack: "lite", verbose: false)
          .and_return(command_double)
        expect(command_double).to receive(:call).with(%w[bundle exec rspec])
        subject
      end
    end

    context "with a verbose argument" do
      let(:args) { ["--verbose"] }
      it "runs in the verbose mode" do
        expect(GovukDocker::Commands::Run)
          .to receive(:new).with(stack: "lite", verbose: true)
          .and_return(command_double)
        expect(command_double).to receive(:call).with([])
        subject
      end
    end

    context "without a verbose argument" do
      let(:args) { [] }
      it "runs in silent mode" do
        expect(GovukDocker::Commands::Run)
          .to receive(:new).with(stack: "lite", verbose: false)
          .and_return(command_double)
        expect(command_double).to receive(:call).with([])
        subject
      end
    end
  end

  describe "be" do
    let(:command) { "be" }
    let(:args) { %w[rspec] }

    it "runs the `run` command with `bundle exec` plus additional arguments" do
      expect(GovukDocker::Commands::Run)
        .to receive(:new).with(stack: "lite", verbose: false)
        .and_return(command_double)
      expect(command_double).to receive(:call).with(%w[bundle exec rspec])
      subject
    end
  end

  describe "startup" do
    let(:command) { "startup" }

    context "without a variation argument" do
      it "runs in the app stack" do
        expect(GovukDocker::Commands::Startup).to receive(:new).and_return(command_double)
        expect(command_double).to receive(:call).with(nil)
        subject
      end
    end

    context "with a variation argument" do
      let(:args) { %w(live) }

      it "runs in the specified stack" do
        expect(GovukDocker::Commands::Startup).to receive(:new).and_return(command_double)
        expect(command_double).to receive(:call).with("live")
        subject
      end
    end
  end

  describe "doctor" do
    let(:command) { "doctor" }

    context "without a fix argument" do
      it "runs a checkup of all the services" do
        expect(GovukDocker::Commands::Doctor).to receive(:new).and_return(command_double)
        expect(command_double).to receive(:call).with(nil)
        subject
      end
    end

    context "with a fix argument" do
      let(:args) { %w(fix) }

      it "runs a checkup of all the services and attempts to fix problems" do
        expect(GovukDocker::Commands::Doctor).to receive(:new).and_return(command_double)
        expect(command_double).to receive(:call).with("fix")
        subject
      end
    end
  end

  describe "build" do
    let(:command) { "build" }

    context "without the service argument" do
      it "builds the working directory's service" do
        expect(GovukDocker::Commands::Build)
          .to receive(:new).with(stack: "lite", verbose: false)
          .and_return(command_double)
        subject
      end
    end

    context "with the service argument" do
      let(:args) { ["--service", "static"] }

      it "builds the specified service" do
        expect(GovukDocker::Commands::Build)
          .to receive(:new).with(service: "static", stack: "lite", verbose: false)
          .and_return(command_double)
        subject
      end
    end
  end
end
